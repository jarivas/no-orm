<?php

namespace Entity;

{{class_description}}
class {{class_name}}
{
    protected static $tableName = '{{table_name}}';

{{constants}}

    protected static $pascalCasedProperties = {{pascal_properties}}
    protected static $snakeCasedProperties = {{snake_properties}}

    public function __call($name, $arguments)
    {
        $methodType = substr($name, 0 , 3);

        if(!in_array($methodType, Connection::$callAllowedTypes))
            throw new Exception('The method do not exists');

        $property = substr($name, 3);

        if (empty(self::$pascalCasedProperties[$property]))
            throw new Exception("The property {$property} you are trying to access do not exists");


        if ($methodType === 'get') return $this->$property;

        $this->$property = $arguments[0];

        return $this;
    }

    public static function get(array $projection = [], array $where = [], string $group = '', array $having = [], string $order = '', int $limit = 1000, int $offset = 0) : array
    {
        if(!count($projection))
            $projection = array_values(self::$pascalCasedProperties);

        $sql = Connection::generateSelect(self::$tableName, self::generateProjection($projection), $where, $group, $having, $order, $limit, $offset);

        $connection = Connection::getInstance();

        return $connection->get($sql, __CLASS__);
    }

    protected static function generateProjection($projection) : array
    {
        $result = [];

        foreach ($projection as $col) {
            $alias = self::$snakeCasedProperties[$col];
            $result[] = "$col as $alias";
        }

        return $result;
    }

    public static function insertOne(array $columns, array $values, string $onDuplicateKeyUpdate = '') : int
    {
        $sql = Connection::generateInsert(self::$tableName, $columns, $values, $onDuplicateKeyUpdate);

        $connection = Connection::getInstance();

        return $connection->executeSql($sql);
    }

    public static function update(array $assignments, array $where = [], string $order = '', int $limit = 0) : bool
    {
        $sql = Connection::generateUpdate(self::$tableName, $assignments, $where, $order, $limit);

        $connection = Connection::getInstance();

        return ($connection->executeSql($sql) > 0);
    }

    public static function delete(array $where = [], string $order = '', int $limit = 0): bool
    {
        $sql = Connection::generateDelete(self::$tableName, $where, $order, $limit);

        $connection = Connection::getInstance();

        return ($connection->executeSql($sql) > 0);
    }
}
